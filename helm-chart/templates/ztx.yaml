{{- define "ztxInitContainer" -}}
{{ if .Values.ztx.enabled }}
initContainers:
  - name: init-ztx
    image: busybox:1.28
    command: ['sh', '-c']
    args: ["iptables -t mangle -A PREROUTING -p sctp -m mark ! --mark 12 -j NFQUEUE --queue-num 0 ; iptables -t mangle -A OUTPUT -p sctp -m mark ! --mark 12 -j NFQUEUE --queue-num 0 ; iptables -t mangle -A PREROUTING -p udp ! --dport 53 -m mark ! --mark 12 -j NFQUEUE --queue-num 0 ; iptables -t mangle -A OUTPUT -p udp ! --dport 53 -m mark ! --mark 12 -j NFQUEUE --queue-num 0"]
{{ end }}
{{- end -}}

{{- define "ztxAppTemplate" -}}
{{ if .Values.ztx.enabled }}
- name: {{ .Values.ztx.name | quote }}
  image: "{{ .Values.ztx.image.repository }}:{{ .Values.ztx.image.tag }}"
  imagePullPolicy: {{ .Values.ztx.image.pullPolicy }}
  securityContext:
    capabilities:
      add:
      - NET_ADMIN
      - NET_RAW
    privileged: true
    runAsGroup: 1592
  command: ["/root/5gsec/src/app"]
  env:
  - name: ENCRYPTION_ENABLED
    value: {{ .Values.ztx.encryption | default "false" | quote }}
  - name: MY_IP
    valueFrom:
      fieldRef:
        fieldPath: status.podIP
{{ end }}
{{- end -}}
